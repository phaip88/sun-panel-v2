name: Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-linux-amd64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Build Frontend
        run: |
          pnpm install
          pnpm run build

      - name: Setup Go bindata tools
        run: |
          go install -a -v github.com/go-bindata/go-bindata/...@latest
          go install -a -v github.com/elazarl/go-bindata-assetfs/...@latest

      - name: Build Backend Assets
        run: |
          cd service
          go-bindata-assetfs -o=assets/bindata.go -pkg=assets assets/...

      - name: Build Linux Binary (amd64)
        run: |
          cd service
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o sun-panel main.go

      - name: Create Release Package
        run: |
          mkdir -p release/sun-panel-linux-amd64
          cp service/sun-panel release/sun-panel-linux-amd64/
          cp -r dist release/sun-panel-linux-amd64/web
          
          # Create start script
          cat > release/sun-panel-linux-amd64/start.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          chmod +x sun-panel
          ./sun-panel
          EOF
          chmod +x release/sun-panel-linux-amd64/start.sh
          
          cd release
          tar -czf sun-panel-linux-amd64.tar.gz sun-panel-linux-amd64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sun-panel-linux-amd64
          path: release/sun-panel-linux-amd64.tar.gz

  build-linux-musl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Build Frontend
        run: |
          pnpm install
          pnpm run build

      - name: Setup Go bindata tools
        run: |
          go install -a -v github.com/go-bindata/go-bindata/...@latest
          go install -a -v github.com/elazarl/go-bindata-assetfs/...@latest

      - name: Build Backend Assets
        run: |
          cd service
          go-bindata-assetfs -o=assets/bindata.go -pkg=assets assets/...

      - name: Install musl cross compiler
        run: |
          curl -L -o x86_64-linux-musl-cross.tgz https://musl.nn.ci/x86_64-linux-musl-cross.tgz
          tar xf x86_64-linux-musl-cross.tgz --strip-components 1 -C /usr/local
          rm x86_64-linux-musl-cross.tgz

      - name: Build Linux Binary (musl static)
        run: |
          cd service
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 CC=x86_64-linux-musl-gcc \
            go build -ldflags "-linkmode external -extldflags '-static -fpic'" \
            -o sun-panel main.go

      - name: Create Release Package
        run: |
          mkdir -p release/sun-panel-linux-musl-amd64
          cp service/sun-panel release/sun-panel-linux-musl-amd64/
          cp -r dist release/sun-panel-linux-musl-amd64/web
          
          cat > release/sun-panel-linux-musl-amd64/start.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          chmod +x sun-panel
          ./sun-panel
          EOF
          chmod +x release/sun-panel-linux-musl-amd64/start.sh
          
          cd release
          tar -czf sun-panel-linux-musl-amd64.tar.gz sun-panel-linux-musl-amd64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sun-panel-linux-musl-amd64
          path: release/sun-panel-linux-musl-amd64.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Build Frontend
        run: |
          pnpm install
          pnpm run build

      - name: Setup Go bindata tools
        run: |
          go install -a -v github.com/go-bindata/go-bindata/...@latest
          go install -a -v github.com/elazarl/go-bindata-assetfs/...@latest

      - name: Build Backend Assets
        run: |
          cd service
          go-bindata-assetfs -o=assets/bindata.go -pkg=assets assets/...

      - name: Build Windows Binary
        run: |
          cd service
          $env:CGO_ENABLED=1
          go build -o sun-panel.exe main.go

      - name: Create Release Package
        run: |
          mkdir -p release/sun-panel-windows-amd64
          cp service/sun-panel.exe release/sun-panel-windows-amd64/
          cp -r dist release/sun-panel-windows-amd64/web
          Compress-Archive -Path release/sun-panel-windows-amd64 -DestinationPath release/sun-panel-windows-amd64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sun-panel-windows-amd64
          path: release/sun-panel-windows-amd64.zip

  release:
    needs: [build-linux-amd64, build-linux-musl, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get Version
        id: version
        run: |
          VERSION=$(date +'%Y%m%d-%H%M%S')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=v$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: Sun-Panel-V2 ${{ steps.version.outputs.TAG }}
          body: |
            # Sun-Panel-V2 é¢„ç¼–è¯‘ç‰ˆæœ¬
            
            æ— éœ€ç¼–è¯‘ï¼Œç›´æ¥ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶å³å¯è¿è¡Œã€‚
            
            ## ğŸ“¦ ä¸‹è½½
            
            | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|------|
            | Linux (glibc) | `sun-panel-linux-amd64.tar.gz` | é€‚ç”¨äºå¤§å¤šæ•° Linux å‘è¡Œç‰ˆ |
            | Linux (musl) | `sun-panel-linux-musl-amd64.tar.gz` | é™æ€ç¼–è¯‘ï¼Œå…¼å®¹æ€§æ›´å¥½ï¼ˆæ¨èï¼‰ |
            | Windows | `sun-panel-windows-amd64.zip` | Windows 64ä½ |
            
            ## ğŸš€ å¿«é€Ÿéƒ¨ç½²
            
            ### Linux éƒ¨ç½²ï¼ˆæ¨èä½¿ç”¨ musl ç‰ˆæœ¬ï¼‰
            ```bash
            # ä¸‹è½½
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG }}/sun-panel-linux-musl-amd64.tar.gz
            
            # è§£å‹
            tar -xzf sun-panel-linux-musl-amd64.tar.gz
            cd sun-panel-linux-musl-amd64
            
            # è¿è¡Œ
            ./start.sh
            
            # æˆ–ç›´æ¥è¿è¡Œ
            chmod +x sun-panel
            ./sun-panel
            ```
            
            ### Windows éƒ¨ç½²
            ```
            1. ä¸‹è½½ sun-panel-windows-amd64.zip
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. åŒå‡»è¿è¡Œ sun-panel.exe
            ```
            
            ## ğŸŒ è®¿é—®åœ°å€
            
            - åœ°å€: http://localhost:3002
            - è´¦å·: admin
            - å¯†ç : 123456
            
            ## âš™ï¸ é…ç½®
            
            é¦–æ¬¡è¿è¡Œä¼šåœ¨ `conf/` ç›®å½•ç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚
            
            ## ğŸ“ æ³¨æ„äº‹é¡¹
            
            - **musl ç‰ˆæœ¬**ï¼šé™æ€ç¼–è¯‘ï¼Œå…¼å®¹æ€§æœ€å¥½ï¼Œæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ
            - **glibc ç‰ˆæœ¬**ï¼šåŠ¨æ€é“¾æ¥ï¼Œéœ€è¦ç³»ç»Ÿæœ‰å¯¹åº”çš„ glibc åº“
            - å¦‚æœé‡åˆ° `GLIBC_xxx not found` é”™è¯¯ï¼Œè¯·ä½¿ç”¨ musl ç‰ˆæœ¬
          files: |
            artifacts/sun-panel-linux-amd64/sun-panel-linux-amd64.tar.gz
            artifacts/sun-panel-linux-musl-amd64/sun-panel-linux-musl-amd64.tar.gz
            artifacts/sun-panel-windows-amd64/sun-panel-windows-amd64.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Success
        run: |
          echo "âœ… Build and release completed!"
          echo "ğŸ“¦ Release: ${{ steps.version.outputs.TAG }}"
