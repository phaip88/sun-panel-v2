name: Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-linux-musl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Build Frontend
        run: |
          pnpm install
          pnpm run build

      - name: Setup Go bindata tools
        run: |
          go install -a -v github.com/go-bindata/go-bindata/...@latest
          go install -a -v github.com/elazarl/go-bindata-assetfs/...@latest

      - name: Build Backend Assets
        run: |
          cd service
          go-bindata-assetfs -o=assets/bindata.go -pkg=assets assets/...

      - name: Install musl tools
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Build Linux Binary (musl static)
        run: |
          cd service
          CC=musl-gcc CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
            go build -ldflags '-linkmode external -extldflags "-static"' \
            -o sun-panel main.go

      - name: Create Release Package
        run: |
          mkdir -p release/sun-panel-linux-amd64
          cp service/sun-panel release/sun-panel-linux-amd64/
          cp -r dist release/sun-panel-linux-amd64/web
          
          cat > release/sun-panel-linux-amd64/start.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          chmod +x sun-panel
          ./sun-panel
          EOF
          chmod +x release/sun-panel-linux-amd64/start.sh
          
          cd release
          tar -czf sun-panel-linux-amd64.tar.gz sun-panel-linux-amd64

      - name: Get Version
        id: version
        run: |
          VERSION=$(date +'%Y%m%d-%H%M%S')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=v$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: Sun-Panel-V2 ${{ steps.version.outputs.TAG }}
          body: |
            # Sun-Panel-V2 é¢„ç¼–è¯‘ç‰ˆæœ¬ (é™æ€ç¼–è¯‘)
            
            æ— éœ€ä»»ä½•ä¾èµ–ï¼Œç›´æ¥ä¸‹è½½è¿è¡Œã€‚
            
            ## ğŸ“¦ ä¸‹è½½
            
            - **Linux (x86_64)**: `sun-panel-linux-amd64.tar.gz` (é™æ€ç¼–è¯‘ï¼Œå…¼å®¹æ‰€æœ‰ Linux)
            
            ## ğŸš€ å¿«é€Ÿéƒ¨ç½²
            
            ```bash
            # ä¸‹è½½
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG }}/sun-panel-linux-amd64.tar.gz
            
            # è§£å‹
            tar -xzf sun-panel-linux-amd64.tar.gz
            cd sun-panel-linux-amd64
            
            # è¿è¡Œ
            ./start.sh
            
            # æˆ–åå°è¿è¡Œ
            nohup ./sun-panel > sun-panel.log 2>&1 &
            ```
            
            ## ğŸŒ è®¿é—®åœ°å€
            
            - åœ°å€: http://localhost:3002
            - è´¦å·: admin
            - å¯†ç : 123456
          files: |
            release/sun-panel-linux-amd64.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Success
        if: success()
        run: echo "âœ… Build completed!"

      - name: Build Failed
        if: failure()
        run: |
          echo "âŒ Build failed!"
          exit 1
